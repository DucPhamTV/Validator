version: '3.2'

services:
  redis:
    image: redis:alpine
    volumes:
      - redis-data:/data

  db:
    image: postgres:12-alpine
    environment:
      - POSTGRES_DB=thenewboston_pv
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - C_FORCE_ROOT=true
    volumes:
      - postgresql-data:/var/lib/postgresql/data
      - ./scripts/docker_entrypoints/initdb.d:/docker-entrypoint-initdb.d

  pv:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=44f338c2dd81953449fea7934a66df64808a976d208cc979ab77cb86e5328e93
      - NODE_IDENTIFIER=c09d58113434868aedf2d610105c4b0b72c9c504845b2b91ff096bf6da3de549
      - NODE_PORT=8001
      - REDIS_DB=0
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_pv
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    env_file:
      - .env
    entrypoint: /opt/project/scripts/docker_entrypoints/entrypoint_pv.sh
    volumes:
      - .:/opt/project
      - ./media/pv:/opt/project/media
    ports:
      - 8001:8000
    links:
      - db
      - redis
    depends_on:
      - db
      - redis

  cv1:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=1a66e8e14a30e3d106cf8b242793f1bc33d36b068c9a70c18329c71e094cec9b
      - NODE_IDENTIFIER=d3c65bf3e986f5875d81358818f88cfc6b54d8747ec839847f005e53580f51eb
      - NODE_PORT=8002
      - REDIS_DB=1
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_cv1
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    env_file:
      - .env
    entrypoint: /opt/project/scripts/docker_entrypoints/entrypoint_cv.sh
    volumes:
      - .:/opt/project
      - ./media/cv1:/opt/project/media
    ports:
      - 8002:8000
    links:
      - pv
      - db
      - redis
    depends_on:
      - pv
      - db
      - redis

  cv2:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=794dcf9674580d881f94d93ff819750a247b8a0bf0b1d320a274cc2c989bd367
      - NODE_IDENTIFIER=4606a234ab7d09e0b5f04fc396a61b9272fcc8846d9c01cc61ac22c26af5d3b8
      - NODE_PORT=8003
      - REDIS_DB=2
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_cv2
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    env_file:
      - .env
    entrypoint: /opt/project/scripts/docker_entrypoints/entrypoint_cv.sh
    volumes:
      - .:/opt/project
      - ./media/cv2:/opt/project/media
    ports:
      - 8003:8000
    links:
      - pv
      - db
      - redis
    depends_on:
      - pv
      - db
      - redis

  bank:
    image: docker.pkg.github.com/thenewboston-developers/bank/bank:latest
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=efae2c6db31f0296e40e3294229c4c7e17501b31e58e02ac9746aa8dbf14f6c0
      - NODE_IDENTIFIER=54e16bed3162cc3a47dec1bcbb9215d256f080d1842734a72f7679f293b52f30
      - NODE_PORT=8004
      - REDIS_DB=3
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_bank
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    env_file:
      - .env
    entrypoint: /opt/project/scripts/docker_entrypoints/entrypoint.sh
    ports:
      - 8004:8000
    links:
      - pv
      - db
      - redis
    depends_on:
      - pv
      - db
      - redis

  celery_pv:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=44f338c2dd81953449fea7934a66df64808a976d208cc979ab77cb86e5328e93
      - REDIS_DB=0
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_pv
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    command: celery -A config.settings worker -l debug -Q celery,block_queue,confirmation_block_queue
    volumes:
      - .:/opt/project
    links:
      - pv
      - db
      - redis
    depends_on:
      - db
      - redis

  celery_cv1:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=1a66e8e14a30e3d106cf8b242793f1bc33d36b068c9a70c18329c71e094cec9b
      - REDIS_DB=1
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_cv1
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    command: celery -A config.settings worker -l debug -Q celery,block_queue,confirmation_block_queue
    volumes:
      - .:/opt/project
    links:
      - cv1
      - db
      - redis
    depends_on:
      - db
      - redis

  celery_cv2:
    build:
      dockerfile: Dockerfile
      context: .
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=794dcf9674580d881f94d93ff819750a247b8a0bf0b1d320a274cc2c989bd367
      - REDIS_DB=2
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_cv2
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    command: celery -A config.settings worker -l debug -Q celery,block_queue,confirmation_block_queue
    volumes:
      - .:/opt/project
    links:
      - cv2
      - db
      - redis
    depends_on:
      - db
      - redis

  celery_bank:
    image: docker.pkg.github.com/thenewboston-developers/bank/bank:latest
    environment:
      - DJANGO_APPLICATION_ENVIRONMENT=local
      - NETWORK_SIGNING_KEY=efae2c6db31f0296e40e3294229c4c7e17501b31e58e02ac9746aa8dbf14f6c0
      - REDIS_DB=3
      - REDIS_HOST=redis
      - POSTGRES_HOST=db
      - POSTGRES_DB=thenewboston_bank
      - POSTGRES_USER=thenewboston
      - POSTGRES_PASSWORD=thenewboston
      - SECRET_KEY=somesecret
    command: celery -A config.settings worker -l debug
    links:
      - bank
      - db
      - redis
    depends_on:
      - db
      - redis

volumes:
  postgresql-data:
    driver: local

  redis-data:
    driver: local
